pipeline:
  identify:
    image: docker
    commands:
      - set -o pipefail
      - apk add --no-cache curl git jq
      - git clone git://git.netfilter.org/iptables /tmp/iptables
      - echo $(git -C /tmp/iptables describe --tags $(git -C /tmp/iptables rev-list --tags --max-count=1) | sed -e 's/^v//') > .iptables_ver
      - echo $(curl -fLqsS 'https://api.github.com/repos/madler/zlib/tags' | jq -r '.[0].name' | sed -e 's/^v//') > .zlib_ver
      - echo $(curl -fLqsS http://code.kryo.se/iodine/ | sed -n 's/Latest.*:.*<b>\([0-9\.]*\).*/\1/p') > .iodine_ver

  build:
    image: spritsail/docker-build
    volumes: [ '/var/run/docker.sock:/var/run/docker.sock' ]
    repo: iodine-dev
    build_args:
      - 'IPTABLES_VER=%file: .iptables_ver'
      - 'ZLIB_VER=%file: .zlib_ver'
      - 'IODINE_VER=%file: .iodine_ver'

  publish:
    image: spritsail/docker-publish
    volumes: [ '/var/run/docker.sock:/var/run/docker.sock' ]
    secrets: [ docker_username, docker_password, microbadger_token ]
    when: { event: [push, tag, deployment] }
    from: iodine-dev
    repo: spritsail/iodine
    tags:
      - 'latest'
      - '%file: .iodine_ver'

  notify:
    image: spritsail/notify
    when: { status: [ success, failure ] }
    secrets: [ webhook_url, notify_token ]
